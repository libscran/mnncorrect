<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>mnncorrect: C++ library for MNN correction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">mnncorrect
   </div>
   <div id="projectbrief">A C++ library for MNN batch correction</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">C++ library for MNN correction </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md__github_workspace_README"></a> <img src="https://github.com/LTLA/CppMnnCorrect/actions/workflows/run-tests.yaml/badge.svg" alt="Unit tests" style="pointer-events: none;" class="inline"/> <img src="https://github.com/LTLA/CppMnnCorrect/actions/workflows/doxygenate.yaml/badge.svg" alt="Documentation" style="pointer-events: none;" class="inline"/> <img src="https://github.com/LTLA/CppMnnCorrect/actions/workflows/compare-R.yaml/badge.svg" alt="R comparison" style="pointer-events: none;" class="inline"/> <a href="https://codecov.io/gh/LTLA/CppMnnCorrect"><img src="https://codecov.io/gh/LTLA/CppMnnCorrect/branch/master/graph/badge.svg?token=J3dxS3MtT1" alt="codecov" style="pointer-events: none;" class="inline"/></a></p>
<h1>Overview</h1>
<p >This library provides functionality for batch correction of arbitrary data via the use of mutual nearest neighbors (MNNs). MNN correction was initially described in the context of single-cell RNA sequencing data analysis (see <a href="https://doi.org/10.1038/nbt.4091">Haghverdi et al., 2018</a>) but the same methodology can be applied for any high-dimensional data containing shared populations across multiple batches. The MNN implementation here is based on the <code>fastMNN()</code> function in the <a href="https://bioconductor.org/packages/batchelor"><b>batchelor</b> package</a>, which provides a number of improvements and speed-ups over the original method in the Haghverdi paper.</p>
<h1>Quick start</h1>
<p >Given a dense feature-by-observation matrix in column-major format and a batch assignment vector for each observation (i.e., column), we can compute corrected values:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="MnnCorrect_8hpp.html">mnncorrect/MnnCorrect.hpp</a>&quot;</span></div>
<div class="line"> </div>
<div class="line">std::vector&lt;double&gt; matrix(ndim * nobs); <span class="comment">// fill with values...</span></div>
<div class="line">std::vector&lt;int&gt; batch(nobs) <span class="comment">// fill with values...</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classmnncorrect_1_1MnnCorrect.html">mnncorrect::MnnCorrect&lt;&gt;</a> runner;</div>
<div class="line">std::vector&lt;double&gt; output(ndim * nobs);</div>
<div class="line">runner.run(ndim, nobs, matrix.data(), batch.data(), output.data());</div>
<div class="ttc" id="aMnnCorrect_8hpp_html"><div class="ttname"><a href="MnnCorrect_8hpp.html">MnnCorrect.hpp</a></div><div class="ttdoc">Batch correction using mutual nearest neighbors.</div></div>
<div class="ttc" id="aclassmnncorrect_1_1MnnCorrect_html"><div class="ttname"><a href="classmnncorrect_1_1MnnCorrect.html">mnncorrect::MnnCorrect</a></div><div class="ttdoc">Batch correction using mutual nearest neighbors.</div><div class="ttdef"><b>Definition:</b> MnnCorrect.hpp:45</div></div>
</div><!-- fragment --><p >See the <a href="https://ltla.github.io/CppMnnCorrect">reference documentation</a> for more details.</p>
<h1>Theoretical details</h1>
<p >We assume that (i) our batches share some subpopulations, and (ii) even after the addition of an arbitrary batch effect, the cells from one subpopulation in one batch are still closer to the cells in the corresponding subpopulation in the other batch (and vice versa) when compared to cells in different subpopulations. Thus, by identifying pairs of cells that are MNNs, we can determine which subpopulations are shared across batches. Any differences in location between batches for the shared subpopulations are attributed to batch effects and targeted for removal. In contrast, a subpopulation unique to a single batch will not contain any MNNs (and thus will not interfere with correction), as it will not have a corresponding subpopulation in the other batch for which it can be the closest neighbor.</p>
<p >To remove batch effects, we consider one batch to be the "reference" and another to be the "target". For each MNN pair, we compute a correction vector that moves the target batch towards the reference. For each observation in the target batch, we identify the closest <code>k</code> observations in the same batch that are part of a MNN pair (i.e., "MNN-involved observations"). We then compute a robust average across all of the correction vectors associated with those closest observations. This average is used as the correction vector for that observation, allowing the correction to adjust to local variations in the magnitude and direction of the batch effect.</p>
<p >The correction vector for each MNN pair is not directly computed from the two paired observations. Rather, for each observation, we compute a "center of mass" using neighboring points from the same batch. Specifically, given an observation <b>v</b> that is part of an MNN pair, we find the set <b>S</b> of observations in the same batch for which <b>v</b> is one of the <code>k</code> closest neighbors. We take the robust average of the coordinates in <b>S</b>, which is defined as the center of mass location for <b>v</b>. The correction vector is then computed between the two center of mass locations across batches. This aims to eliminate "kissing" effects where the correction only brings the surfaces of the batches into contact.</p>
<p >As an additional note, the center of mass calculation excludes all observations that are more than a threshold distance away from <b>v</b>. To choose this threshold, we compute the distances from each observation in <b>S</b> to <b>v</b>, and we pool this across all <b>v</b> involved in MNN pairs. We then use the "median + 3 MAD" approach on the resulting distribution of distances to define a threshold. The aim is to ensure that the threshold is large enough to capture cells from the same subpopulation without including cells from distinct subpopulations. Our assumption is that most cells in each batch belong to a shared subpopulation.</p>
<p >In the case of &gt;2 batches, we progressively merge the batches to a reference, i.e., after each merge step, the merged dataset is used as the new reference to merge the next batch, and so on. By default, we use the largest batch as the reference and we choose the batch with the most MNN pairs to merge at each step. This ensures that we have a plentiful number of MNNs for a stable correction at each step. Indeed, it allows us to merge together batches that share no subpopulations as long as there is an intervening batch that can "plug the gap", so to speak.</p>
<h1>Examples</h1>
<p >The <code>tests/R/examples</code> directory contains a few examples using the C++ code on some real datasets (namely, single-cell RNA-seq datasets). To run these, install the package at <code>tests/R/package</code> (this requires the <a href="https://github.com/LTLA/scran.chan"><b>scran.chan</b></a> package, which also wraps this C++ library in a more complete package).</p>
<p ><code>pbmc</code>: mergesthe PBMC 3K and 4K datasets from 10X Genomics. These are technical replicates (I think) so a complete merge is to be expected.</p>
<p ><img src="https://raw.githubusercontent.com/LTLA/CppMnnCorrect/images/tests/R/examples/pbmc/output.png" alt="pbmc-output" class="inline"/></p>
<p ><code>pancreas</code>: merges the <a href="https://dx.doi.org/10.1016%2Fj.stem.2016.05.010">Grun et al. (2016)</a> and <a href="https://doi.org/10.1016/j.cels.2016.09.002">Muraro et al. (2016)</a> datasets. I believe this involves data from different patients but using the same-ish technology.</p>
<p ><img src="https://raw.githubusercontent.com/LTLA/CppMnnCorrect/images/tests/R/examples/pancreas/output.png" alt="pancreas-output" class="inline"/></p>
<p ><code>neurons</code>: merges the <a href="https://doi.org/10.1126/science.aaa1934">Zeisel et al. (2015)</a> and <a href="https://doi.org/10.1038/nn.4216">Tasic et al. (2016)</a> datasets. This involves different technologies and different cell populations.</p>
<p ><img src="https://raw.githubusercontent.com/LTLA/CppMnnCorrect/images/tests/R/examples/neurons/output.png" alt="neurons-output" class="inline"/></p>
<h1>Building projects</h1>
<p >If you're using CMake, you just need to add something like this to your <code>CMakeLists.txt</code>:</p>
<div class="fragment"><div class="line">include(FetchContent)</div>
<div class="line"> </div>
<div class="line">FetchContent_Declare(</div>
<div class="line">  libscran</div>
<div class="line">  GIT_REPOSITORY https://github.com/LTLA/libscran</div>
<div class="line">  GIT_TAG master # or any version of interest</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">FetchContent_MakeAvailable(libscran)</div>
</div><!-- fragment --><p >Then you can link to <b>libscran</b> to make the headers available during compilation:</p>
<div class="fragment"><div class="line"># For executables:</div>
<div class="line">target_link_libraries(myexe libscran)</div>
<div class="line"> </div>
<div class="line"># For libaries</div>
<div class="line">target_link_libraries(mylib INTERFACE libscran)</div>
</div><!-- fragment --><p >If you're not using CMake, the simple approach is to just copy the files - either directly or with Git submodules - and include their path during compilation with, e.g., GCC's <code>-I</code>. Note that this requires manual management of the <a href="https://github.com/LTLA/knncolle"><b>knncolle</b></a> library for k-nearest neighbor detection. This in turn has a suite of its own dependencies, see the link for details.</p>
<h1>References</h1>
<p >Haghverdi L, Lun ATL, Morgan MD, Marioni JC (2018). Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors. <em>Nat. Biotechnol.</em> 36(5):421-427 </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
